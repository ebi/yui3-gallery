YUI.add("gallery-database-manager",function(a){var d="DatabaseManager",n=a.Lang,h=n.isString,g="1",t="yuiGalleryKeyValueStore",q="disabled",r="dbHandle",b="databaseName",s="databaseTable",u="databaseDescription",p="databaseSize",j="defaultLifetime",c="checkLifetime",f="saveDisable",k="dbDisabledPropertyName",o="allowsAccess",m="customFields",i="supportsDB";function e(l,v){if(n.isUndefined(l)){}else{}if(n.isUndefined(v)){}else{}}a.DatabaseManager=a.Base.create(d,a.Base,[],{initializer:function(v){v=v||{};var l=null,y,w=this.get(s);if(this.get(o)){try{l=this._getDatabase(this.get(b),"",this.get(u),this.get(p));this.get(m).push({name:"value",type:"BLOB"});if(l.version!==g){if(""===l.version){y=this.get(m);l.changeVersion(l.version,g,function(z){var A="CREATE TABLE "+w+" (id TEXT PRIMARY KEY, ";a.each(y,function(B){A+=B.name+" "+B.type+", ";});A+="timeWritten INTEGER, lifetime INTEGER);";z.executeSql(A);},function(){},e);}}else{this.removeExpired();}}catch(x){this._disableDBAccess();}}this._set(r,l);},_getDatabase:function(v,l,x,w){return openDatabase(v,l,x,w);},_getNow:function(){return Math.floor(Date.now()/1000);},setItem:function(x,z,l){if(!this.get(r)){return;}l=l||this.get(j);var v=[x],y="",w="";w="REPLACE INTO "+this.get(s)+" (id, ";if(h(z)){v.push(z);w+="value, ";y="?, ";}else{a.each(this.get(m),function(A){if(!n.isUndefined(z[A.name])){w+=A.name+", ";y+="?, ";v.push(z[A.name]);}});}v.push(this._getNow(),l);w+="timeWritten, lifetime) VALUES (?, "+y+"?, ?);";this.get(r).transaction(function(A){A.executeSql(w,v,null,e);});},getItem:function(l,y,x){var w=this._getNow(),v=this;if(!this.get(r)){y.call(y,null);return;}x=a.Lang.isUndefined(x)?this.get(c):x;this.get(r).transaction(function(z){z.executeSql("SELECT * FROM "+v.get(s)+" WHERE id = :key;",[l],function(A,B){if(0===B.rows.length){y.call(y,null);return;}var C=B.rows.item(0);if(x&&0<C.lifetime&&w>(C.timeWritten+C.lifetime)){v.removeItem(l);y.call(y,null);return;}y.call(y,C);},e);});},removeItem:function(l){var v=this.get(s);if(!this.get(r)){return;}this.get(r).transaction(function(w){var x="DELETE FROM "+v+" WHERE id = :key;";w.executeSql(x,[l],null,e);});},removeExpired:function(){var v=this._getNow(),l=this.get(s);if(!this.get(r)){return;}this.get(r).transaction(function(w){var x="DELETE FROM "+l+" WHERE 0 < lifetime AND :time > (timeWritten + lifetime);";w.executeSql(x,[v],null,e);});},_disableDBAccess:function(){var l=this.get(k);this._set(o,false);if(!this.get(f)){return;}try{localStorage.setItem(l,q);}catch(v){a.Cookie.set(l,q);}},_supportsDB:function(){return !!window.openDatabase;},_allowsDBAccess:function(){if(this.get(i)){try{if(null===localStorage.getItem(this.get(k))){return this._allowsDBAccessByCookie();}else{return false;}}catch(l){return this._allowsDBAccessByCookie();}}return false;},_allowsDBAccessByCookie:function(){if(null===a.Cookie.get(this.get(k))){return true;}return false;}},{ATTRS:{dbHandle:{readOnly:true},databaseName:{value:d,validator:h,writeOnce:"initOnly"},databaseTable:{value:t,validator:h,readOnly:true},databaseSize:{value:5*1024*1024,validator:n.isNumber,writeOnce:"initOnly"},databaseDescription:{value:"Default YUI3 Gallery DatabaseManager Database",validator:h,writeOnce:"initOnly"},defaultLifetime:{value:0,validator:n.isNumber},checkLifetime:{value:true,validator:n.isBoolean},saveDisable:{value:true,validator:n.isBoolean},dbDisabledPropertyName:{value:d+"disabledDB"},allowsAccess:{valueFn:"_allowsDBAccess",readOnly:true},supportsDB:{valueFn:"_supportsDB",readOnly:true},customFields:{value:[]}}});},"@VERSION@",{requires:["base","cookie"]});