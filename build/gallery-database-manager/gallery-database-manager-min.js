YUI.add("gallery-database-manager",function(a){var d="DatabaseManager",m=a.Lang,g=m.isString,f="1",s="yuiGalleryKeyValueStore",p="disabled",q="dbHandle",b="databaseName",r="databaseTable",t="databaseDescription",o="databaseSize",i="defaultLifetime",c="checkLifetime",j="dbDisabledPropertyName",n="allowsAccess",k="customFields",h="supportsDB";function e(l,u){if(m.isUndefined(l)){}else{}if(m.isUndefined(u)){}else{}}a.DatabaseManager=a.Base.create(d,a.Base,[],{initializer:function(u){u=u||{};var l=null,x,v=this.get(r);if(this.get(n)){try{l=this._getDatabase(this.get(b),"",this.get(t),this.get(o));this.get(k).push({name:"value",type:"BLOB"});if(l.version!==f){if(""===l.version){x=this.get(k);l.changeVersion(l.version,f,function(y){var z="CREATE TABLE "+v+" (id TEXT PRIMARY KEY, ";a.each(x,function(A){z+=A.name+" "+A.type+", ";});z+="timeWritten INTEGER, lifetime INTEGER);";y.executeSql(z);},function(){},e);}}else{this.removeExpired();}}catch(w){this._disableDBAccess();}}this._set(q,l);},_getDatabase:function(u,l,w,v){return openDatabase(u,l,w,v);},_getNow:function(){return Date.now();},setItem:function(w,y,l){if(!this.get(q)){return;}l=l||this.get(i);var u=[w],x="",v="";v="REPLACE INTO "+this.get(r)+" (id, ";if(g(y)){u.push(y);v+="value, ";x="?, ";}else{a.each(this.get(k),function(z){if(!m.isUndefined(y[z.name])){v+=z.name+", ";x+="?, ";u.push(y[z.name]);}});}u.push(this._getNow(),l);v+="timeWritten, lifetime) VALUES (?, "+x+"?, ?);";this.get(q).transaction(function(z){z.executeSql(v,u,null,e);});},getItem:function(l,x,w){var v=this._getNow(),u=this;if(!this.get(q)){x.call(x,null);return;}w=a.Lang.isUndefined(w)?this.get(c):w;this.get(q).transaction(function(y){y.executeSql("SELECT * FROM "+u.get(r)+" WHERE id = :key;",[l],function(z,A){if(0===A.rows.length){x.call(x,null);return;}var B=A.rows.item(0);if(w&&0<B.lifetime&&v>(B.timeWritten+B.lifetime)){u.removeItem(l);x.call(x,null);return;}x.call(x,B);},e);});},removeItem:function(l){var u=this.get(r);if(!this.get(q)){return;}this.get(q).transaction(function(v){var w="DELETE FROM "+u+" WHERE id = :key;";v.executeSql(w,[l],null,e);});},removeExpired:function(){var u=this._getNow(),l=this.get(r);if(!this.get(q)){return;}this.get(q).transaction(function(v){var w="DELETE FROM "+l+" WHERE 0 < lifetime AND :time > (timeWritten + lifetime);";v.executeSql(w,[u],null,e);});},_disableDBAccess:function(){var l=this.get(j);this._set(n,false);try{localStorage.setItem(l,p);}catch(u){a.Cookie.set(l,p);}},_supportsDB:function(){return !!window.openDatabase;},_allowsDBAccess:function(){if(this.get(h)){try{if(null===localStorage.getItem(this.get(j))){return this._allowsDBAccessByCookie();}else{return false;}}catch(l){return this._allowsDBAccessByCookie();}}return false;},_allowsDBAccessByCookie:function(){if(null===a.Cookie.get(this.get(j))){return true;}return false;}},{ATTRS:{dbHandle:{readOnly:true},databaseName:{value:d,validator:g,writeOnce:"initOnly"},databaseTable:{value:s,validator:g,readOnly:true},databaseSize:{value:5*1024*1024,validator:m.isNumber,writeOnce:"initOnly"},databaseDescription:{value:"Default YUI3 Gallery DatabaseManager Database",validator:g,writeOnce:"initOnly"},defaultLifetime:{value:0,validator:m.isNumber},checkLifetime:{value:true,validator:m.isBoolean},dbDisabledPropertyName:{value:d+"disabledDB"},allowsAccess:{valueFn:"_allowsDBAccess",readOnly:true},supportsDB:{valueFn:"_supportsDB",readOnly:true},customFields:{value:[]}}});},"@VERSION@",{requires:["base","cookie"]});